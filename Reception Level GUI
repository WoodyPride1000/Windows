import React, { useState, useEffect, useRef, useCallback } from 'react';

// ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
const App = () => {
  // æ–¹ä½è§’ã¨ä»°ä¿¯è§’ã®ç¯„å›²
  const AZIMUTH_MIN = -180;
  const AZIMUTH_MAX = 180;
  const ELEVATION_MIN = -90;
  const ELEVATION_MAX = 90;
  const GRID_SIZE = 50; // ãƒ‡ãƒ¼ã‚¿ã‚°ãƒªãƒƒãƒ‰ã®è§£åƒåº¦

  // å—ä¿¡ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’æ ¼ç´ã™ã‚‹çŠ¶æ…‹
  const [receptionData, setReceptionData] = useState([]);
  // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã€Œä¿¡å·æºã€ã®å¼·åº¦ã‚’åˆ¶å¾¡ã™ã‚‹ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®å€¤
  const [signalStrength, setSignalStrength] = useState(50);
  // ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã€Œä¿¡å·æºã€ã®ä½ç½® (ã‚¢ã‚¸ãƒã‚¹, ã‚¨ãƒ¬ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³)
  const [signalSourceAzimuth, setSignalSourceAzimuth] = useState(0);
  const [signalSourceElevation, setSignalSourceElevation] = useState(0);
  

  const canvasRef = useRef(null);

  // å—ä¿¡ãƒ¬ãƒ™ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•° (ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨)
  const generateReceptionData = useCallback(() => {
    const data = [];
    const azimuthStep = (AZIMUTH_MAX - AZIMUTH_MIN) / GRID_SIZE;
    const elevationStep = (ELEVATION_MAX - ELEVATION_MIN) / GRID_SIZE;

    // ä¿¡å·æºã‹ã‚‰ã®è·é›¢ã«åŸºã¥ã„ã¦ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®—
    for (let i = 0; i <= GRID_SIZE; i++) {
      const currentElevation = ELEVATION_MIN + i * elevationStep;
      const row = [];
      for (let j = 0; j <= GRID_SIZE; j++) {
        const currentAzimuth = AZIMUTH_MIN + j * azimuthStep;

        // ä¿¡å·æºã‹ã‚‰ã®è·é›¢ãŒè¿‘ã„ã»ã©ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„
        const distAzimuth = currentAzimuth - signalSourceAzimuth;
        const distElevation = currentElevation - signalSourceElevation;
        const distance = Math.sqrt(distAzimuth * distAzimuth + distElevation * distElevation);

        // è·é›¢ã¨ä¿¡å·å¼·åº¦ã«åŸºã¥ã„ã¦ãƒ¬ãƒ™ãƒ«ã‚’è¨ˆç®— (0-100)
        let level = Math.max(0, 100 - distance * 2 - (100 - signalStrength));
        row.push(level);
      }
      data.push(row);
    }
    setReceptionData(data);
  }, [signalStrength, signalSourceAzimuth, signalSourceElevation]);

  // ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã¨ã‚­ãƒ£ãƒ³ãƒã‚¹æç”»ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹useEffect
  useEffect(() => {
    generateReceptionData();
  }, [generateReceptionData]);

  // ã‚­ãƒ£ãƒ³ãƒã‚¹ã«ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã¨ç…§æº–å™¨ã‚’æç”»ã™ã‚‹é–¢æ•°
  const drawCanvas = useCallback(() => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã®ã‚µã‚¤ã‚ºã‚’è¦ªè¦ç´ ã«åˆã‚ã›ã‚‹
    const parent = canvas.parentElement;
    canvas.width = parent.clientWidth;
    canvas.height = parent.clientHeight;

    const width = canvas.width;
    const height = canvas.height;

    ctx.clearRect(0, 0, width, height);

    if (receptionData.length === 0) return;

    // ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã®æç”»
    const cellWidth = width / GRID_SIZE;
    const cellHeight = height / GRID_SIZE;

    for (let i = 0; i < receptionData.length; i++) {
      for (let j = 0; j < receptionData[i].length; j++) {
        const level = receptionData[i][j]; // 0-100
        const hue = (100 - level) * 1.2; // ãƒ¬ãƒ™ãƒ«ãŒé«˜ã„ã»ã©èµ¤ (0) ã«è¿‘ã¥ã (hue 0ã¯èµ¤ã€120ã¯ç·‘)
        ctx.fillStyle = `hsl(${hue}, 100%, 50%)`; // HSLã‚«ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨
        ctx.fillRect(j * cellWidth, height - (i + 1) * cellHeight, cellWidth, cellHeight);
      }
    }

    // ç…§æº–å™¨ã®æç”»
    ctx.strokeStyle = 'white';
    ctx.lineWidth = 2;

    // ä¸­å¤®ã®åå­—ç·š
    ctx.beginPath();
    ctx.moveTo(width / 2, 0);
    ctx.lineTo(width / 2, height);
    ctx.moveTo(0, height / 2);
    ctx.lineTo(width, height / 2);
    ctx.stroke();

    // ä¸­å¤®ã®å††
    ctx.beginPath();
    ctx.arc(width / 2, height / 2, 20, 0, Math.PI * 2);
    ctx.stroke();

    // è»¸ã®ãƒ©ãƒ™ãƒ« (ç°¡ç•¥åŒ–ã•ã‚ŒãŸç›®ç››ã‚Š)
    ctx.fillStyle = 'white';
    ctx.font = '12px Inter, sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';

    // æ–¹ä½è§’ (Xè»¸)
    ctx.fillText(`${AZIMUTH_MIN}Â°`, width * 0.1, height - 10);
    ctx.fillText('0Â° (æ–¹ä½è§’)', width / 2, height - 10);
    ctx.fillText(`${AZIMUTH_MAX}Â°`, width * 0.9, height - 10);

    // ä»°ä¿¯è§’ (Yè»¸)
    ctx.save(); // ç¾åœ¨ã®ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ã‚’ä¿å­˜
    ctx.translate(10, height / 2); // åŸç‚¹ã‚’ç§»å‹•
    ctx.rotate(-Math.PI / 2); // -90åº¦å›è»¢
    ctx.fillText(`${ELEVATION_MIN}Â°`, 0, 0);
    ctx.restore(); // ã‚­ãƒ£ãƒ³ãƒã‚¹çŠ¶æ…‹ã‚’å¾©å…ƒ

    ctx.save();
    ctx.translate(10, height * 0.1);
    ctx.rotate(-Math.PI / 2);
    ctx.fillText(`${ELEVATION_MAX}Â°`, 0, 0);
    ctx.restore();

    ctx.fillText('0Â° (ä»°ä¿¯è§’)', 20, height / 2);

  }, [receptionData]);

  // receptionDataãŒæ›´æ–°ã•ã‚ŒãŸã‚‰ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’æç”»
  useEffect(() => {
    drawCanvas();
  }, [receptionData, drawCanvas]);

  // ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã®ãƒªã‚µã‚¤ã‚ºæ™‚ã«ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’å†æç”»
  useEffect(() => {
    const handleResize = () => drawCanvas();
    window.addEventListener('resize', handleResize);
    return () => window.removeEventListener('resize', handleResize);
  }, [drawCanvas]);

  // ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã§ä¿¡å·æºã®ä½ç½®ã‚’ç§»å‹•
  const handleCanvasClick = (e) => {
    const canvas = canvasRef.current;
    if (!canvas) return;

    const rect = canvas.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸Šã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã‚’æ–¹ä½è§’ãƒ»ä»°ä¿¯è§’ã«å¤‰æ›
    const newAzimuth = AZIMUTH_MIN + (x / canvas.width) * (AZIMUTH_MAX - AZIMUTH_MIN);
    // Yè»¸ã¯ä¸ŠãŒæ­£ãªã®ã§ã€ã‚­ãƒ£ãƒ³ãƒã‚¹ã®yåº§æ¨™ã‚’åè»¢ã•ã›ã‚‹å¿…è¦ãŒã‚ã‚‹
    const newElevation = ELEVATION_MAX - (y / canvas.height) * (ELEVATION_MAX - ELEVATION_MIN);

    setSignalSourceAzimuth(newAzimuth);
    setSignalSourceElevation(newElevation);
    
  };

  

  return (
    <div className="flex flex-col items-center justify-center w-screen h-screen bg-gray-900 text-white p-4 font-sans antialiased">
      <style>
        {`
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        html, body, #root {
          height: 100%;
          margin: 0;
          padding: 0;
          overflow: hidden;
        }
        body {
          font-family: 'Inter', sans-serif;
        }
        `}
      </style>

      <h1 className="text-4xl font-bold mb-6 text-green-400">å—ä¿¡å…¥åŠ›ãƒ¬ãƒ™ãƒ«è¡¨ç¤º ğŸ¯</h1>

      <div className="relative w-full max-w-4xl h-96 bg-gray-800 rounded-lg shadow-lg overflow-hidden border-2 border-green-500 mb-6 flex items-center justify-center">
        <canvas
          ref={canvasRef}
          className="w-full h-full cursor-crosshair"
          onClick={handleCanvasClick}
        ></canvas>
        <div className="absolute top-2 left-2 text-sm text-white bg-black bg-opacity-50 p-1 rounded">
          ã‚¯ãƒªãƒƒã‚¯ã§ä¿¡å·æºã‚’ç§»å‹•
        </div>
        {/* ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å€¤ã‚’è¡¨ç¤ºã™ã‚‹é ˜åŸŸ */}
        <div className="absolute bottom-2 left-2 text-sm text-white bg-black bg-opacity-50 p-1 rounded">
          ä¿¡å·æº: æ–¹ä½è§’: {signalSourceAzimuth.toFixed(1)}Â°, ä»°ä¿¯è§’: {signalSourceElevation.toFixed(1)}Â°
          <br />
          ä¿¡å·å¼·åº¦: {signalStrength}%
        </div>
      </div>

      <div className="w-full max-w-4xl bg-gray-800 p-4 rounded-lg shadow-lg flex flex-col md:flex-row items-center justify-around gap-4 border border-gray-700">
        <div className="flex items-center gap-3 w-full md:w-1/2">
          <label htmlFor="signalStrength" className="text-lg text-gray-300 min-w-max">
            ä¿¡å·å¼·åº¦:
          </label>
          <input
            type="range"
            id="signalStrength"
            min="0"
            max="100"
            value={signalStrength}
            onChange={(e) => setSignalStrength(Number(e.target.value))}
            className="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg accent-green-500"
          />
          <span className="text-lg text-green-400 w-12 text-right">{signalStrength}%</span>
        </div>
        
      
      </div>

      <p className="mt-8 text-gray-400 text-sm text-center">
        ã“ã®ãƒ‡ãƒ¢ã¯ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿¡å·æºã‚’ç§»å‹•ã•ã›ã€ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã§å¼·åº¦ã‚’èª¿æ•´ã§ãã¾ã™ã€‚
      </p>
    </div>
  );
};

export default App;
